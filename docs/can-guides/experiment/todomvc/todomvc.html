<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="./todomvc.css"/>
    </head>
    <body>

<script>
	if(!(window.console && console.log)) {
	  console = {
	    log: function(){},
	    debug: function(){},
	    info: function(){},
	    warn: function(){},
	    error: function(){}
	  };
	}
</script>
<script src="../../../../node_modules/es6-promise/dist/es6-promise.auto.js"></script>

<script type='text/stache' id='todo-create-template'>
<input id="new-todo"
    placeholder="What needs to be done?"
    value:bind="todo.name"
    on:enter="createTodo()"/>
</script>

<script type='text/stache' id='todo-list-template'>
<ul id="todo-list">
  {{#each(todos)}}
    <li class="todo {{#if(./complete)}}completed{{/if}}
      {{#if(isDestroying)}}destroying{{/if}}
      {{#if(isEditing(this))}}editing{{/if}}">
      <div class="view">
        <input class="toggle" type="checkbox" checked:bind="complete">
        <label on:dblclick="edit(this)">{{name}}</label>
        <button class="destroy" on:click="destroy(this)"></button>
      </div>
      <input class="edit" type="text"
        value:bind="name"
        on:enter="updateName()"
        focused:from="isEditing(this)"
        on:blur="cancelEdit()"/>
    </li>
  {{/each}}
</ul>
</script>

<script type="text/stache" id="todomvc-template">
<section id="todoapp">
	<header id="header">
		<h1>todos</h1>
		<todo-create addTodo:from="@addTodo"/>
	</header>
	<section id="main" class="">
		<input id="toggle-all" type="checkbox"
          checked:bind="allChecked"
          />
		<label for="toggle-all">Mark all as complete</label>
		<todo-list todos:from="todosList" destroy:from="@destroyTodo"/>
	</section>
	<footer id="footer" class="">
		<span id="todo-count">
			<strong>{{todosPromise.value.active.length}}</strong> items left
		</span>
		<ul id="filters">
			<li>
				<a href="{{routeUrl(filter=undefined)}}"
					{{#routeCurrent(filter=undefined)}}class='selected'{{/routeCurrent}}>All</a>
			</li>
			<li>
				<a href="{{routeUrl(filter='active')}}"
					{{#routeCurrent(filter='active')}}class='selected'{{/routeCurrent}}>Active</a>
			</li>
			<li>
				<a href="{{routeUrl(filter='complete')}}"
					{{#routeCurrent(filter='complete')}}class='selected'{{/routeCurrent}}>Completed</a>
			</li>
		</ul>
		<button id="clear-completed"
            on:click="todosPromise.value.destroyComplete()">
			Clear completed ({{todosPromise.value.complete.length}})
		</button>
	</footer>
</section>
</script>

<script src="../../../../node_modules/steal/steal.js"></script>
<script>
steal("can-jquery", "can/all.js", function($, can) {

window.Todo = class Todo {
	constructor(obj) {
		this.complete = false;
		can.Reflect.assign(this, obj || {});
		return can.observe(this);
	}
	set complete(val) {
		this._complete = val;
	}
	get complete() {
		return this._complete !== "false" && !!this._complete;
	}
	serialize() {
		var obj = {};
		for(var i in this) {
			if(typeof this[i] !== "function") {
				obj[i] = this[i];
			}
		}
		return obj;
	}
}

window.TodoList = class TodoList extends Array {
	constructor(val) {
		super(0);
		//Object.setPrototypeOf(this, TodoList.prototype); //<-- this bullshit is needed for Babel
		if(val instanceof Array) {
			this.push.apply(this, val);
		} else {
			can.Reflect.assign(this, val || {} );
		}
		return can.observe(this);
	}
  active(){
    return this.filter(todo => !todo.complete);
  }
  complete(){
    return this.filter(todo => todo.complete);
  }
  allComplete(){
    return this.length === this.complete().length;
  }
  updateCompleteTo(value){
    this.forEach(function(todo){
      todo.complete = value;
    });
  }
  destroyComplete(){
    this.complete().forEach(todo => {
      this.splice(this.indexOf(todo), 1);
    });
  }
  // equiv to 
  push(...objs) {
  	objs.forEach((obj) => {
	  	if(!(obj instanceof Todo)) {
	  		obj = new Todo(obj);
	  	}
	  	[].push.call(this, obj);
  	});
  }
  splice(index, count, ...objs) {
  	objs.forEach((obj, i) => {
	  	if(!(obj instanceof Todo)) {
	  		objs[i] = new Todo(obj);
	  	}
  	});
  	[].splice.apply(this, [index, count].concat(objs));
  }
  static get name() {
  	return "TodoList";
  }
};
Todo.List = TodoList;

class TodoCreateVM {
	constructor(obj) {
		this.todo = new Todo();
		obj && can.Reflect.assign(this, obj);
		return can.observe(this);
	}
  createTodo(){
    this.addTodo(this.todo);
    this.todo = new Todo();
  }
}

can.Component.extend({
  tag: "todo-create",
  view: can.stache.from("todo-create-template"),
  ViewModel: TodoCreateVM
});

class TodoListVM {
  // todos: Todo.List,
  // editing: Todo,
  // backupName: "string",
  constructor(obj) {
  	can.Reflect.assign(this, obj || {});
  	return can.observe(this);
  }
  isEditing(todo){
    return todo === this.editing;
  }
  edit(todo){
    this.backupName = todo.name;
    this.editing = todo;
  }
  cancelEdit(){
    if(this.editing) {
      this.editing.name = this.backupName;
    }
    this.editing = null;
  }
  updateName() {
    this.editing = null;
  }
  destroy() {}
}

can.Component.extend({
  tag: "todo-list",
  view: can.stache.from("todo-list-template"),
  ViewModel: TodoListVM
});

var AppVM = can.DefineMap.extend({seal: false},{
  filter: "string",
  route: "string",
  get todosPromise() {
		return Promise.resolve(
			new Todo.List([{ name: "mow lawn", complete: false, id: 5 },
			  { name: "dishes", complete: true, id: 6 },
  			{ name: "learn canjs", complete: false, id: 7 }])
			);
  },
  todos: {
  	get(lastSetVal, resolve) {
	  	this.todosPromise.then(resolve);
	  }
  },
  todosList: {
    get: function(){
    	var filter = this.filter;
    	if(this.todos) {
	    	return filter ? this.todos.filter(x => x.complete === (filter === "complete")) : this.todos;
	    }
    }
  },
  addTodo(todo) {
  	this.todosPromise.then(allTodos => allTodos.push(todo));
  },
  get allChecked(){
    return this.todosList && this.todosList.allComplete();
  },
  set allChecked(newVal){
      this.todosList && this.todosList.updateCompleteTo(newVal);
  },
  destroyTodo(todo) {
  	this.todosPromise.then(todos => todos.splice(todos.indexOf(todo), 1));
  }
});

var template = can.stache.from("todomvc-template");

var appVM = window.appVM = new AppVM();
can.route.data = appVM;
can.route("{filter}");
can.route.ready();

var frag = template(appVM);
document.body.appendChild(frag);
});
</script>

    </body>
</html>
